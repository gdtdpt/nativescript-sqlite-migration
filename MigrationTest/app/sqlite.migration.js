"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var DBMigration = (function () {
    function DBMigration() {
    }
    DBMigration.init = function (db, callback) {
        Migrator.setup(db, callback);
    };
    DBMigration.migrate = function (version, callback) {
        Migrator.migrate(version, callback);
    };
    DBMigration.defineMigration = function (version, actions) {
        Migrator.migration(version, actions);
    };
    return DBMigration;
}());
exports.DBMigration = DBMigration;
var Migrator = (function () {
    function Migrator() {
    }
    Migrator.version = function (callback) {
        var self = this;
        self.db.all('SELECT current_version FROM schema_version').then(function (result) {
            if (result.length == 0) {
                self.db.execSQL('INSERT INTO schema_version VALUES (0)').then(function (err, result) {
                    callback(0);
                });
            }
            else {
                callback(result[0][0]);
            }
        });
    };
    Migrator.setVersion = function (db, version, callback) {
        this.db.execSQL('UPDATE schema_version SET current_version = ?', [version]).then(function () {
            Migrator._version = version;
            if (callback)
                callback();
        });
    };
    Migrator.setup = function (db, callback) {
        var _this = this;
        this.db = db;
        db.execSQL('CREATE TABLE IF NOT EXISTS schema_version (current_version INTEGER)').then(function () {
            _this.migration(0, { up: function () { console.log('setup up.'); }, down: function () { console.log("setup down."); } });
            Migrator.migrations.forEach(function (migrationObj, index) {
                migrationObj.db = db;
            });
            if (callback)
                callback();
        });
    };
    Migrator.reset = function (callback) {
        Migrator.migrations = [];
        Migrator.setVersion(0, callback);
    };
    Migrator.migration = function (version, actions) {
        Migrator.migrations[version] = new Migration(version, actions);
        return Migrator.migrations[version];
    };
    Migrator.migrateUpTo = function (version, callback) {
        var migrationsToRun = [];
        function migrateOne() {
            var migration = migrationsToRun.pop();
            if (!migration)
                callback();
            migration.up(function () {
                if (migrationsToRun.length > 0) {
                    migrateOne();
                }
                else if (callback) {
                    callback();
                }
            });
        }
        this.version(function (currentVersion) {
            for (var v = currentVersion + 1; v <= version; v++) {
                migrationsToRun.unshift(Migrator.migrations[v]);
            }
            if (migrationsToRun.length > 0) {
                migrateOne();
            }
            else if (callback) {
                callback();
            }
        });
    };
    Migrator.migrateDownTo = function (version, callback) {
        var migrationsToRun = [];
        function migrateOne() {
            var migration = migrationsToRun.pop();
            if (!migration)
                callback();
            migration.down(function () {
                if (migrationsToRun.length > 0) {
                    migrateOne();
                }
                else if (callback) {
                    callback();
                }
            });
        }
        this.version(function (currentVersion) {
            for (var v = currentVersion - 1; v >= version; v--) {
                migrationsToRun.unshift(Migrator.migrations[v]);
            }
            if (migrationsToRun.length > 0) {
                migrateOne();
            }
            else if (callback) {
                callback();
            }
        });
    };
    Migrator.migrate = function (version, callback) {
        if (callback === undefined) {
            callback = version;
            version = this.migrations.length - 1;
        }
        this.version(function (currentVersion) {
            if (currentVersion < version) {
                Migrator.migrateUpTo(version, callback);
            }
            else if (currentVersion > version) {
                Migrator.migrateDownTo(version, callback);
            }
            else {
                callback();
            }
        });
    };
    return Migrator;
}());
Migrator.migrations = [];
var Migration = (function () {
    function Migration(version, body) {
        this.version = version;
        this.body = body;
        this.actions = [];
    }
    Migration.prototype.executeActions = function (callback, customVersion) {
        var actionsToRun = this.actions;
        var version = (customVersion !== undefined) ? customVersion : this.version;
        function nextAction(db) {
            if (actionsToRun.length == 0) {
                Migrator.setVersion(db, version, callback);
            }
            else {
                var action = actionsToRun.pop();
                action(db, nextAction);
            }
        }
        nextAction(this.db);
    };
    Migration.prototype.up = function (callback) {
        if (this.body.up)
            this.body.up.apply(this, [this]);
        this.executeActions(callback);
    };
    Migration.prototype.down = function (callback) {
        if (this.body.down)
            this.body.down.apply(this, [this]);
        this.executeActions(callback);
    };
    Migration.prototype.addColumn = function (tableName, columnName, columnType) {
        var sql = 'ALTER TABLE ' + tableName + ' ADD ' + columnName + ' ' + columnType;
        this.executeSql(sql);
    };
    Migration.prototype.removeColumn = function (tableName, columnName) {
        var self = this;
        this.action(function (db, nextCommand) {
            var sql = 'SELECT sql FROM sqlite_master WHERE type="table" AND name=="' + tableName + '"';
            db.all(sql).then(function (result) {
                var _start = result[0][0].indexOf('(');
                var _end = result[0][0].indexOf(')');
                var _tmp = result[0][0].substring(_start + 1, _end);
                var columns = _tmp.split(',');
                var selectColumns = [];
                var columnsSql = [];
                columns.forEach(function (column, index) {
                    var colName = new RegExp("((`\\w+`)|(\\w+)) .+").exec(column)[1].trim();
                    if (colName != columnName) {
                        columnsSql.push(column);
                        selectColumns.push(colName);
                    }
                });
                var columnsSqlStr = columnsSql.join(', ');
                var selectColumnsStr = selectColumns.join(', ');
                var queries = [];
                queries.unshift("ALTER TABLE " + tableName + " RENAME TO " + tableName + "_bkp;");
                queries.unshift("CREATE TABLE " + tableName + " (" + columnsSql + ");");
                queries.unshift("INSERT INTO " + tableName + " SELECT " + selectColumns + " FROM " + tableName + "_bkp;");
                queries.unshift("DROP TABLE " + tableName + "_bkp;");
                function executeQueriesSeq(queries, nextCommand) {
                    if (queries.length > 0) {
                        var sql_1 = queries.pop();
                        self.db.execSQL(sql_1).then(function () {
                            if (queries.length) {
                                executeQueriesSeq(queries, nextCommand);
                            }
                            else {
                                nextCommand();
                            }
                        });
                    }
                }
                executeQueriesSeq(queries, nextCommand);
            });
        });
    };
    Migration.prototype.addIndex = function (tableName, columnName, unique) {
        var sql = 'CREATE ' + (unique === true ? 'UNIQUE' : '') + ' INDEX ' + tableName + '_' + columnName + ' ON ' + tableName + ' (' + columnName + ')';
        this.executeSql(sql);
    };
    Migration.prototype.removeIndex = function (tableName, columnName) {
        var sql = 'DROP INDEX ' + tableName + '_' + columnName;
        this.executeSql(sql);
    };
    Migration.prototype.executeSql = function (sql, args) {
        this.action(function (db, nextCommand) {
            db.execSQL(sql, args).then(function () {
                nextCommand();
            });
        });
    };
    Migration.prototype.action = function (callback) {
        this.actions.unshift(callback);
    };
    return Migration;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FsaXRlLm1pZ3JhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNxbGl0ZS5taWdyYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTtJQUFBO0lBVUEsQ0FBQztJQVRRLGdCQUFJLEdBQVgsVUFBWSxFQUFFLEVBQUUsUUFBUTtRQUN0QixRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBQ00sbUJBQU8sR0FBZCxVQUFlLE9BQU8sRUFBRSxRQUFTO1FBQy9CLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFDTSwyQkFBZSxHQUF0QixVQUF1QixPQUFPLEVBQUUsT0FBTztRQUNyQyxRQUFRLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBQ0gsa0JBQUM7QUFBRCxDQUFDLEFBVkQsSUFVQztBQVZZLGtDQUFXO0FBWXhCO0lBQUE7SUEySEEsQ0FBQztJQXRIUSxnQkFBTyxHQUFkLFVBQWUsUUFBUTtRQUNyQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsNENBQTRDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxNQUFNO1lBQ3BFLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdkIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsdUNBQXVDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxHQUFHLEVBQUUsTUFBTTtvQkFDeEUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNkLENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FB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QUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFDSCxnQkFBQztBQUFELENBQUMsQUEvR0QsSUErR0MiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgY2xhc3MgREJNaWdyYXRpb24ge1xuICBzdGF0aWMgaW5pdChkYiwgY2FsbGJhY2spIHtcbiAgICBNaWdyYXRvci5zZXR1cChkYiwgY2FsbGJhY2spO1xuICB9XG4gIHN0YXRpYyBtaWdyYXRlKHZlcnNpb24sIGNhbGxiYWNrPykge1xuICAgIE1pZ3JhdG9yLm1pZ3JhdGUodmVyc2lvbiwgY2FsbGJhY2spO1xuICB9XG4gIHN0YXRpYyBkZWZpbmVNaWdyYXRpb24odmVyc2lvbiwgYWN0aW9ucykge1xuICAgIE1pZ3JhdG9yLm1pZ3JhdGlvbih2ZXJzaW9uLCBhY3Rpb25zKTtcbiAgfVxufVxuXG5jbGFzcyBNaWdyYXRvciB7XG4gIHN0YXRpYyBtaWdyYXRpb25zID0gW107XG4gIHN0YXRpYyBfdmVyc2lvbjtcbiAgc3RhdGljIGRiO1xuXG4gIHN0YXRpYyB2ZXJzaW9uKGNhbGxiYWNrKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIHNlbGYuZGIuYWxsKCdTRUxFQ1QgY3VycmVudF92ZXJzaW9uIEZST00gc2NoZW1hX3ZlcnNpb24nKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09IDApIHtcbiAgICAgICAgc2VsZi5kYi5leGVjU1FMKCdJTlNFUlQgSU5UTyBzY2hlbWFfdmVyc2lvbiBWQUxVRVMgKDApJykudGhlbigoZXJyLCByZXN1bHQpID0+IHtcbiAgICAgICAgICBjYWxsYmFjaygwKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYWxsYmFjayhyZXN1bHRbMF1bMF0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIHNldFZlcnNpb24oZGIsIHZlcnNpb24sIGNhbGxiYWNrPykge1xuICAgIHRoaXMuZGIuZXhlY1NRTCgnVVBEQVRFIHNjaGVtYV92ZXJzaW9uIFNFVCBjdXJyZW50X3ZlcnNpb24gPSA/JywgW3ZlcnNpb25dKS50aGVuKCgpID0+IHtcbiAgICAgIE1pZ3JhdG9yLl92ZXJzaW9uID0gdmVyc2lvbjtcbiAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTtcbiAgICB9KVxuICB9XG5cbiAgc3RhdGljIHNldHVwKGRiLCBjYWxsYmFjaz86ICgpID0+IHZvaWQpIHtcbiAgICB0aGlzLmRiID0gZGI7XG4gICAgZGIuZXhlY1NRTCgnQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgc2NoZW1hX3ZlcnNpb24gKGN1cnJlbnRfdmVyc2lvbiBJTlRFR0VSKScpLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5taWdyYXRpb24oMCwgeyB1cDogKCkgPT4ge2NvbnNvbGUubG9nKCdzZXR1cCB1cC4nKX0sIGRvd246ICgpID0+IHtjb25zb2xlLmxvZyhgc2V0dXAgZG93bi5gKX0gfSk7XG4gICAgICBNaWdyYXRvci5taWdyYXRpb25zLmZvckVhY2goKG1pZ3JhdGlvbk9iaiwgaW5kZXgpID0+IHtcbiAgICAgICAgbWlncmF0aW9uT2JqLmRiID0gZGI7XG4gICAgICB9KTtcbiAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTtcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXRpYyByZXNldChjYWxsYmFjaz8pIHtcbiAgICBNaWdyYXRvci5taWdyYXRpb25zID0gW107XG4gICAgTWlncmF0b3Iuc2V0VmVyc2lvbigwLCBjYWxsYmFjayk7XG5cbiAgfVxuXG4gIHN0YXRpYyBtaWdyYXRpb24odmVyc2lvbiwgYWN0aW9ucykge1xuICAgIE1pZ3JhdG9yLm1pZ3JhdGlvbnNbdmVyc2lvbl0gPSBuZXcgTWlncmF0aW9uKHZlcnNpb24sIGFjdGlvbnMpO1xuICAgIHJldHVybiBNaWdyYXRvci5taWdyYXRpb25zW3ZlcnNpb25dO1xuICB9XG5cbiAgc3RhdGljIG1pZ3JhdGVVcFRvKHZlcnNpb24sIGNhbGxiYWNrKSB7XG4gICAgbGV0IG1pZ3JhdGlvbnNUb1J1biA9IFtdO1xuXG4gICAgZnVuY3Rpb24gbWlncmF0ZU9uZSgpIHtcbiAgICAgIGxldCBtaWdyYXRpb24gPSBtaWdyYXRpb25zVG9SdW4ucG9wKCk7XG5cbiAgICAgIGlmICghbWlncmF0aW9uKSBjYWxsYmFjaygpO1xuXG4gICAgICBtaWdyYXRpb24udXAoKCkgPT4ge1xuICAgICAgICBpZiAobWlncmF0aW9uc1RvUnVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBtaWdyYXRlT25lKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLnZlcnNpb24oKGN1cnJlbnRWZXJzaW9uKSA9PiB7XG4gICAgICBmb3IgKGxldCB2ID0gY3VycmVudFZlcnNpb24rMTsgdiA8PSB2ZXJzaW9uOyB2KyspIHtcbiAgICAgICAgbWlncmF0aW9uc1RvUnVuLnVuc2hpZnQoTWlncmF0b3IubWlncmF0aW9uc1t2XSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChtaWdyYXRpb25zVG9SdW4ubGVuZ3RoID4gMCkge1xuICAgICAgICBtaWdyYXRlT25lKCk7XG4gICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgbWlncmF0ZURvd25Ubyh2ZXJzaW9uLCBjYWxsYmFjaykge1xuICAgIGxldCBtaWdyYXRpb25zVG9SdW4gPSBbXTtcblxuICAgIGZ1bmN0aW9uIG1pZ3JhdGVPbmUoKSB7XG4gICAgICBsZXQgbWlncmF0aW9uID0gbWlncmF0aW9uc1RvUnVuLnBvcCgpO1xuXG4gICAgICBpZiAoIW1pZ3JhdGlvbikgY2FsbGJhY2soKTtcblxuICAgICAgbWlncmF0aW9uLmRvd24oKCkgPT4ge1xuICAgICAgICBpZiAobWlncmF0aW9uc1RvUnVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBtaWdyYXRlT25lKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLnZlcnNpb24oKGN1cnJlbnRWZXJzaW9uKSA9PiB7XG4gICAgICBmb3IgKGxldCB2ID0gY3VycmVudFZlcnNpb24tMTsgdiA+PSB2ZXJzaW9uOyB2LS0pIHtcbiAgICAgICAgbWlncmF0aW9uc1RvUnVuLnVuc2hpZnQoTWlncmF0b3IubWlncmF0aW9uc1t2XSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChtaWdyYXRpb25zVG9SdW4ubGVuZ3RoID4gMCkge1xuICAgICAgICBtaWdyYXRlT25lKCk7XG4gICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgbWlncmF0ZSh2ZXJzaW9uLCBjYWxsYmFjaz8pIHtcbiAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY2FsbGJhY2sgPSB2ZXJzaW9uO1xuICAgICAgdmVyc2lvbiA9IHRoaXMubWlncmF0aW9ucy5sZW5ndGggLSAxO1xuICAgIH1cblxuICAgIHRoaXMudmVyc2lvbihjdXJyZW50VmVyc2lvbiA9PiB7XG4gICAgICBpZiAoY3VycmVudFZlcnNpb24gPCB2ZXJzaW9uKSB7XG4gICAgICAgIE1pZ3JhdG9yLm1pZ3JhdGVVcFRvKHZlcnNpb24sIGNhbGxiYWNrKTtcbiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFZlcnNpb24gPiB2ZXJzaW9uKSB7XG4gICAgICAgIE1pZ3JhdG9yLm1pZ3JhdGVEb3duVG8odmVyc2lvbiwgY2FsbGJhY2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG5cbmNsYXNzIE1pZ3JhdGlvbiB7XG4gIGRiO1xuICB2ZXJzaW9uO1xuICBib2R5O1xuICBhY3Rpb25zO1xuXG4gIGNvbnN0cnVjdG9yKHZlcnNpb24sIGJvZHkpIHtcbiAgICB0aGlzLnZlcnNpb24gPSB2ZXJzaW9uO1xuICAgIHRoaXMuYm9keSA9IGJvZHk7XG4gICAgdGhpcy5hY3Rpb25zID0gW107XG4gIH1cblxuICBleGVjdXRlQWN0aW9ucyhjYWxsYmFjaywgY3VzdG9tVmVyc2lvbj8pIHtcbiAgICB2YXIgYWN0aW9uc1RvUnVuID0gdGhpcy5hY3Rpb25zO1xuICAgIHZhciB2ZXJzaW9uID0gKGN1c3RvbVZlcnNpb24gIT09IHVuZGVmaW5lZCkgPyBjdXN0b21WZXJzaW9uIDogdGhpcy52ZXJzaW9uO1xuXG4gICAgZnVuY3Rpb24gbmV4dEFjdGlvbiAoZGIpIHtcbiAgICAgIGlmIChhY3Rpb25zVG9SdW4ubGVuZ3RoID09IDApIHtcbiAgICAgICAgTWlncmF0b3Iuc2V0VmVyc2lvbihkYiwgdmVyc2lvbiwgY2FsbGJhY2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGFjdGlvbiA9IGFjdGlvbnNUb1J1bi5wb3AoKTtcbiAgICAgICAgYWN0aW9uKGRiLCBuZXh0QWN0aW9uKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBuZXh0QWN0aW9uKHRoaXMuZGIpO1xuICB9XG5cbiAgdXAoY2FsbGJhY2spIHtcbiAgICBpZiAodGhpcy5ib2R5LnVwKSB0aGlzLmJvZHkudXAuYXBwbHkodGhpcywgW3RoaXNdKTtcbiAgICB0aGlzLmV4ZWN1dGVBY3Rpb25zKGNhbGxiYWNrKTtcbiAgfVxuXG4gIGRvd24oY2FsbGJhY2spIHtcbiAgICBpZiAodGhpcy5ib2R5LmRvd24pIHRoaXMuYm9keS5kb3duLmFwcGx5KHRoaXMsIFt0aGlzXSk7XG4gICAgdGhpcy5leGVjdXRlQWN0aW9ucyhjYWxsYmFjayk7XG4gIH1cblxuICBhZGRDb2x1bW4odGFibGVOYW1lLCBjb2x1bW5OYW1lLCBjb2x1bW5UeXBlKSB7XG4gICAgbGV0IHNxbCA9ICdBTFRFUiBUQUJMRSAnICsgdGFibGVOYW1lICsgJyBBREQgJyArIGNvbHVtbk5hbWUgKyAnICcgKyBjb2x1bW5UeXBlO1xuICAgIHRoaXMuZXhlY3V0ZVNxbChzcWwpO1xuICB9XG5cbiAgcmVtb3ZlQ29sdW1uKHRhYmxlTmFtZSwgY29sdW1uTmFtZSkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICB0aGlzLmFjdGlvbigoZGIsIG5leHRDb21tYW5kKSA9PiB7XG4gICAgICBsZXQgc3FsID0gJ1NFTEVDVCBzcWwgRlJPTSBzcWxpdGVfbWFzdGVyIFdIRVJFIHR5cGU9XCJ0YWJsZVwiIEFORCBuYW1lPT1cIicgKyB0YWJsZU5hbWUgKyAnXCInO1xuICAgICAgZGIuYWxsKHNxbCkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBsZXQgX3N0YXJ0ID0gcmVzdWx0WzBdWzBdLmluZGV4T2YoJygnKTtcbiAgICAgICAgbGV0IF9lbmQgPSByZXN1bHRbMF1bMF0uaW5kZXhPZignKScpO1xuICAgICAgICBsZXQgX3RtcCA9IHJlc3VsdFswXVswXS5zdWJzdHJpbmcoX3N0YXJ0KzEsIF9lbmQpO1xuICAgICAgICBsZXQgY29sdW1ucyA9IF90bXAuc3BsaXQoJywnKTtcblxuICAgICAgICBsZXQgc2VsZWN0Q29sdW1ucyA9IFtdO1xuICAgICAgICBsZXQgY29sdW1uc1NxbCA9IFtdO1xuXG4gICAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uLCBpbmRleCkgPT4ge1xuICAgICAgICAgIHZhciBjb2xOYW1lID0gbmV3IFJlZ0V4cChcIigoYFxcXFx3K2ApfChcXFxcdyspKSAuK1wiKS5leGVjKGNvbHVtbilbMV0udHJpbSgpO1xuICAgICAgICAgIGlmIChjb2xOYW1lICE9IGNvbHVtbk5hbWUpIHtcbiAgICAgICAgICAgIGNvbHVtbnNTcWwucHVzaChjb2x1bW4pO1xuICAgICAgICAgICAgc2VsZWN0Q29sdW1ucy5wdXNoKGNvbE5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGxldCBjb2x1bW5zU3FsU3RyID0gY29sdW1uc1NxbC5qb2luKCcsICcpOyBcbiAgICAgICAgbGV0IHNlbGVjdENvbHVtbnNTdHIgPSBzZWxlY3RDb2x1bW5zLmpvaW4oJywgJyk7XG5cbiAgICAgICAgbGV0IHF1ZXJpZXMgPSBbXTtcbiAgICAgICAgcXVlcmllcy51bnNoaWZ0KFwiQUxURVIgVEFCTEUgXCIgKyB0YWJsZU5hbWUgKyBcIiBSRU5BTUUgVE8gXCIgKyB0YWJsZU5hbWUgKyBcIl9ia3A7XCIpO1xuICAgICAgICBxdWVyaWVzLnVuc2hpZnQoXCJDUkVBVEUgVEFCTEUgXCIgKyB0YWJsZU5hbWUgKyBcIiAoXCIgKyBjb2x1bW5zU3FsICsgXCIpO1wiKTtcbiAgICAgICAgcXVlcmllcy51bnNoaWZ0KFwiSU5TRVJUIElOVE8gXCIgKyB0YWJsZU5hbWUgKyBcIiBTRUxFQ1QgXCIgKyBzZWxlY3RDb2x1bW5zICsgXCIgRlJPTSBcIiArIHRhYmxlTmFtZSArIFwiX2JrcDtcIik7XG4gICAgICAgIHF1ZXJpZXMudW5zaGlmdChcIkRST1AgVEFCTEUgXCIgKyB0YWJsZU5hbWUgKyBcIl9ia3A7XCIpO1xuXG4gICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVRdWVyaWVzU2VxKHF1ZXJpZXMsIG5leHRDb21tYW5kKSB7XG4gICAgICAgICAgaWYgKHF1ZXJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbGV0IHNxbCA9IHF1ZXJpZXMucG9wKCk7XG4gICAgICAgICAgICBzZWxmLmRiLmV4ZWNTUUwoc3FsKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHF1ZXJpZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgZXhlY3V0ZVF1ZXJpZXNTZXEocXVlcmllcywgbmV4dENvbW1hbmQpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5leHRDb21tYW5kKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGV4ZWN1dGVRdWVyaWVzU2VxKHF1ZXJpZXMsIG5leHRDb21tYW5kKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYWRkSW5kZXgodGFibGVOYW1lLCBjb2x1bW5OYW1lLCB1bmlxdWUpIHtcbiAgICBsZXQgc3FsID0gJ0NSRUFURSAnICsgKHVuaXF1ZSA9PT0gdHJ1ZT8gJ1VOSVFVRScgOiAnJykgKyAnIElOREVYICcgKyB0YWJsZU5hbWUgKyAnXycgKyBjb2x1bW5OYW1lICsgJyBPTiAnICsgdGFibGVOYW1lICsgJyAoJyArIGNvbHVtbk5hbWUgKyAnKSc7XG4gICAgdGhpcy5leGVjdXRlU3FsKHNxbCk7XG4gIH1cblxuICByZW1vdmVJbmRleCh0YWJsZU5hbWUsIGNvbHVtbk5hbWUpIHtcbiAgICBsZXQgc3FsID0gJ0RST1AgSU5ERVggJyArIHRhYmxlTmFtZSArICdfJyArIGNvbHVtbk5hbWU7XG4gICAgdGhpcy5leGVjdXRlU3FsKHNxbCk7IFxuICB9XG5cbiAgZXhlY3V0ZVNxbChzcWwsIGFyZ3M/KSB7XG4gICAgdGhpcy5hY3Rpb24oKGRiLCBuZXh0Q29tbWFuZCkgPT4ge1xuICAgICAgZGIuZXhlY1NRTChzcWwsIGFyZ3MpLnRoZW4oKCkgPT4ge1xuICAgICAgICBuZXh0Q29tbWFuZCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhY3Rpb24oY2FsbGJhY2s6IChhcmcxLCBhcmcyKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5hY3Rpb25zLnVuc2hpZnQoY2FsbGJhY2spO1xuICB9XG59Il19